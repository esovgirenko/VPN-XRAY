# VPN-XRAY: Антидетектный VPN на Xray-core и протоколе REALITY

Полноценное решение для развёртывания VPN на VPS (Ubuntu 22.04 / Debian 12) с использованием **Xray-core** и протокола **REALITY**. REALITY обеспечивает маскировку трафика через подмену TLS-рукопожатия (fingerprint spoofing) под легитимные сервисы (Cloudflare, Google и др.), делая трафик неотличимым от обычного HTTPS даже для продвинутых систем DPI.

---

## Оглавление

- [Чем REALITY отличается от простой маскировки](#чем-reality-отличается-от-простой-маскировки)
- [Требования](#требования)
- [Структура проекта](#структура-проекта)
- [Установка на VPS](#установка-на-vps)
- [Клиентская утилита](#клиентская-утилита)
- [Тестирование и отладка](#тестирование-и-отладка)
- [Подключение на iPhone и MacBook](#подключение-на-iphone-и-macbook)
- [Поддерживаемые клиенты](#поддерживаемые-клиенты)
- [Таблица совместимости отпечатков и целевых сервисов](#таблица-совместимости-отпечатков-и-целевых-сервисов)
- [Безопасность и ограничение скорости](#безопасность-и-ограничение-скорости)
- [Рекомендации по стойкости](#рекомендации-по-стойкости)
- [Юридическое предупреждение](#юридическое-предупреждение)

---

## Чем REALITY отличается от простой маскировки

**Простая маскировка** (подмена заголовков, fake Host, User-Agent и т.п.) меняет только данные на уровне приложения (L7). Глубокий анализ (DPI) может выявить несоответствие между заголовками и реальным TLS-рукопожатием: отпечаток клиента (JA3/JA3S), порядок расширений, cipher suites и т.д.

**REALITY** принципиально иначе подходит к задаче:

- Подменяется **сам процесс TLS-рукопожатия** на уровне пакетов.
- Клиент при подключении ведёт себя как браузер (Chrome, Firefox, Safari и т.д.) при обращении к **реальному** целевому сайту (например, Cloudflare или Google).
- Сервер не выдаёт свой сертификат; вместо этого используется криптографическая схема (x25519), позволяющая клиенту и серверу согласовать ключи так, что для стороннего наблюдателя сессия выглядит как обычный TLS 1.3 к выбранному dest.
- В результате трафик **неотличим от легитимного HTTPS** к целевому сервису даже для систем анализа 7-го уровня и продвинутого DPI.

То есть REALITY — это не «подмена заголовков», а подмена **всего TLS-профиля** под легитимный сервис.

---

## Требования

- **Сервер:** Ubuntu 22.04 или Debian 12, root или sudo.
- **Клиент:** целевые устройства — **iPhone** и **MacBook**. На ПК для генерации ссылок нужен Python 3.8+; на iPhone/MacBook — приложение с поддержкой REALITY (см. [подключение на iPhone и MacBook](#подключение-на-iphone-и-macbook)).

---

## Структура проекта

```
├── server/
│   ├── install-reality.sh      # Основной скрипт установки (интерактивный)
│   ├── xray-reality.json.tpl   # Шаблон конфигурации (справочный)
│   └── xray.service            # Systemd unit
├── client/
│   ├── reality-link-gen.py     # Генератор ссылок и конфигов
│   ├── requirements.txt       # qrcode
│   └── example-config.json    # Пример клиентской конфигурации
├── test/
│   └── verify-tls.sh           # Проверка TLS и доступности сервера
└── README.md
```

---

## Установка на VPS

### Пошаговая инструкция на чистом VPS

1. **Подключитесь к VPS по SSH** (root или пользователь с sudo).

2. **Скачайте репозиторий** (или скопируйте файлы в каталог, например `/opt/vpn-xray`):

   ```bash
   cd /opt
   git clone <URL_РЕПОЗИТОРИЯ> vpn-xray
   cd vpn-xray
   ```

   Если репозитория нет — скопируйте папки `server/`, `client/`, `test/` и файл `README.md` на сервер вручную.

3. **Запустите установку**:

   ```bash
   chmod +x server/install-reality.sh
   sudo ./server/install-reality.sh
   ```

4. **Ответьте на вопросы скрипта:**
   - Порт: `443`, `8443` или `2053` (рекомендуется 443).
   - **dest** — целевой сервер, под который маскируем TLS (например `www.cloudflare.com:443` или `dns.google:443`).
   - **serverNames** — SNI из сертификата dest (например `www.cloudflare.com,cloudflare.com`).
   - **Fingerprint** — chrome, firefox, safari, ios, android.
   - Количество пользователей — для каждого будет сгенерированы UUID и shortId.

5. **После установки** скрипт:
   - Установит Xray-core с проверкой контрольной суммы;
   - Сгенерирует x25519 ключи (`xray x25519`);
   - Определит внешний IP;
   - Создаст конфиг с flow `xtls-rprx-vision` и настроит systemd и UFW;
   - Сохранит параметры для клиентов в `/usr/local/etc/xray/reality-client-params.json`.

6. **Скачайте с сервера** файл `reality-client-params.json` на свой компьютер (через scp/sftp) для генерации ссылок и конфигов клиента.

---

## Клиентская утилита

Утилита `client/reality-link-gen.py` генерирует ссылки `vless://` и экспортирует конфигурации.

### Установка зависимостей

На Debian/Ubuntu (и других системах с PEP 668) не устанавливайте пакеты в систему — используйте виртуальное окружение. Сначала установите модуль venv (если ещё не установлен):

```bash
sudo apt install python3-venv
```

Затем:

```bash
cd client
python3 -m venv .venv
source .venv/bin/activate   # Linux/macOS
pip install -r requirements.txt
```

Либо один раз создать окружение и ставить зависимости скриптом:

```bash
cd client
chmod +x setup-venv.sh
./setup-venv.sh
```

Дальше запускайте утилиту так (пока активен venv):

```bash
python reality-link-gen.py /path/to/reality-client-params.json
```

Или без активации: `./.venv/bin/python reality-link-gen.py ...`

### Использование

**Ссылка по файлу с сервера** (рекомендуется):

```bash
python reality-link-gen.py /path/to/reality-client-params.json
# или: .venv/bin/python reality-link-gen.py ...
```

**Экспорт в JSON для v2rayN / v2rayNG:**

```bash
python reality-link-gen.py reality-client-params.json --json
```

**Полная клиентская конфигурация** (inbound SOCKS + outbound VLESS REALITY):

```bash
python reality-link-gen.py reality-client-params.json --full-config
```

**QR-код** (удобно для **iPhone** — отсканировать камерой в приложении):

```bash
python reality-link-gen.py reality-client-params.json --qr
```

**Человекочитаемый текст** с пояснением параметров:

```bash
python3 reality-link-gen.py reality-client-params.json --text
```

**Валидация ссылки** (проверка корректности параметров и формата):

```bash
python3 reality-link-gen.py reality-client-params.json --validate
```

**Ручной ввод параметров** (без файла):

```bash
python3 reality-link-gen.py --host 203.0.113.10 --port 443 --uuid <UUID> \
  --public-key <PUBLIC_KEY> --short-id <SHORT_ID> --server-name www.cloudflare.com \
  --fingerprint chrome --tag "MyREALITY"
```

**Генерация UUID v5 по имени пользователя:**

```bash
python3 reality-link-gen.py reality-client-params.json --name "user1" --link
```

Для второго и последующих пользователей укажите `--uuid` и `--short-id` из вывода установки (файл на сервере содержит массив `users` и `shortIds`).

---

## Тестирование и отладка

### Проверка работоспособности (curl + SNI)

Скрипт `test/verify-tls.sh` проверяет доступность порта и TLS с подменой SNI:

```bash
chmod +x test/verify-tls.sh
./test/verify-tls.sh <IP_ВАШЕГО_СЕРВЕРА> 443 www.cloudflare.com
```

Параметры: `HOST`, `PORT`, `SNI` (должен совпадать с одним из serverNames в конфиге).

### Проверка отпечатка TLS (openssl)

Скрипт также выводит информацию о сертификате **целевого** dest (не вашего сервера) через `openssl s_client`, чтобы убедиться, что dest поддерживает TLS 1.3.

### Верификация в Wireshark / TLS-анализаторах

1. Захватите трафик до вашего сервера на порт 443 (или выбранный порт).
2. REALITY маскирует рукопожатие под выбранный dest; внешне трафик должен выглядеть как обычный TLS 1.3 к SNI (например, www.cloudflare.com).
3. В Client Hello должен быть указан выбранный SNI; отпечаток (JA3 и др.) соответствует выбранному fingerprint (chrome, firefox и т.д.).

Подробные подсказки выводятся в конце работы `verify-tls.sh`.

---

## Подключение на iPhone и MacBook

Клиенты в этом проекте рассчитаны на использование с **iPhone** и **MacBook**. Рекомендуемые приложения и порядок подключения ниже.

### iPhone (iOS)

1. **Установите приложение** с поддержкой VLESS + REALITY (Xray-core ≥ 1.7):
   - **Shadowrocket** (App Store, платный) — импорт по ссылке vless:// или по QR-коду.
   - **Streisand** (App Store) — поддержка REALITY, импорт ссылки или конфигурации.
   - **V2Box**, **OneClick** и аналоги — проверьте в описании поддержку «REALITY» и «VLESS».

2. **Получите ссылку или QR-код** на компьютере (см. [Клиентская утилита](#клиентская-утилита)):
   - Ссылку: `python3 reality-link-gen.py reality-client-params.json --link` — скопируйте и вставьте в приложение (добавить по URL).
   - QR-код: `python3 reality-link-gen.py reality-client-params.json --qr` — откройте камеру в приложении и отсканируйте QR с экрана или распечатки.

3. **Рекомендуемый fingerprint при установке сервера** для iPhone: **ios** (или **safari**). В таблице [ниже](#таблица-совместимости-отпечатков-и-целевых-сервисов) для ios подойдут dest с serverNames вроде `www.apple.com`, `www.icloud.com`.

### MacBook (macOS)

1. **Установите приложение** с поддержкой REALITY:
   - **V2rayU** — вкладка «Подключение», добавление по ссылке vless:// или импорт JSON.
   - **Nekoray** (Nekobox для macOS) — поддержка REALITY, импорт ссылки или конфига.
   - **V2rayXS**, **Qv2ray** (если есть поддержка Xray 1.7+) — проверьте наличие REALITY в настройках.

2. **Получите ссылку или конфиг**:
   - Ссылка: `python3 reality-link-gen.py reality-client-params.json --link` — вставьте в поле «URL» / «Ссылка» в приложении.
   - Полный конфиг: `python3 reality-link-gen.py reality-client-params.json --full-config > config.json` — в приложении выберите «Импорт из файла» / «Import config» и укажите `config.json`.

3. **Рекомендуемый fingerprint** для MacBook: **safari** или **chrome** (dest, например, `www.cloudflare.com` или `www.apple.com`).

### Общее

- После импорта выберите созданный профиль и включите туннель (VPN/прокси). Проверьте доступ в интернет.
- Если при установке сервера вы выбрали fingerprint **chrome** или **firefox**, он тоже будет работать на iPhone и MacBook; для большей естественности трафика на iOS лучше **ios** или **safari**, на macOS — **safari** или **chrome**.

### Маршрутизация в Streisand / Shadowrocket (лучший отклик)

Настройки маршрутизации решают, какой трафик идёт через VPN, а какой — напрямую. Это **улучшает отзывчивость**: меньше задержка там, где прокси не нужен.

**Рекомендуемые настройки в Streisand (и аналогично в Shadowrocket):**

1. **Режим маршрутизации**  
   Выберите **«По правилам»** (Rule / Rules) или **«Глобальный — с исключениями»**, а не «Весь трафик», если приложению доступны правила.

2. **Обязательно исключить локальную сеть (LAN)**  
   Чтобы умный дом, принтер, другие устройства в домашней Wi‑Fi не шли через VPN и не добавляли задержку:
   - Включите опцию вроде **«Не проксировать LAN»** / **Bypass LAN** / **Исключить 192.168.0.0/16, 10.0.0.0/8**.
   - Или добавьте правила: `192.168.0.0/16` → Direct, `10.0.0.0/8` → Direct.

3. **Исключить то, что не нужно через VPN**  
   Чем меньше трафика через VPN, тем меньше нагрузка и субъективно лучше отклик:
   - Локальные домены (если есть), стриминг в своей стране — по желанию отправлять в Direct.
   - В Streisand/Shadowrocket можно добавить правила по доменам или гео: нужные сайты/регионы — Proxy, остальное — Direct (или наоборот, в зависимости от цели).

4. **Не проксировать системные и служебные адреса**  
   Если в приложении есть пресет «Исключить системные» / «Bypass private IP» — включите его, чтобы не отправлять в VPN служебный и локальный трафик.

**Итог:** чем меньше трафика гонять через VPN, тем быстрее отклик там, где вы им пользуетесь. ЛAN и ненужные приложения/сайты лучше держать в Direct.

---

## Поддерживаемые клиенты

Требуется поддержка **REALITY** и **VLESS** с flow **xtls-rprx-vision** (Xray-core ≥ 1.7.0). Основные платформы — **iPhone и MacBook**.

| Платформа | Клиент        | Примечание                                      |
|-----------|----------------|-------------------------------------------------|
| **iOS**   | Shadowrocket   | Импорт vless:// или QR, поддержка REALITY       |
| **iOS**   | Streisand      | REALITY, импорт ссылки/конфига                  |
| **macOS** | V2rayU         | Добавление по ссылке, импорт JSON               |
| **macOS** | Nekoray/Nekobox| REALITY, импорт ссылки или конфигурации         |
| Windows   | v2rayN, Nekoray| Для генерации ссылок/конфигов на ПК             |
| Android   | v2rayNG, Nekobox| Импорт vless:// или JSON                       |

Актуальные версии и требования смотрите в описании приложения в App Store или на сайте разработчика.

---

## Таблица совместимости отпечатков и целевых сервисов

| Fingerprint | Рекомендуемый dest (serverNames)        | Примечание                         |
|-------------|-----------------------------------------|------------------------------------|
| **ios**     | www.apple.com, www.icloud.com           | **iPhone** — мобильный Safari      |
| **safari**  | www.apple.com, apple.com                | **MacBook**, iPhone               |
| chrome      | www.cloudflare.com, cloudflare.com      | MacBook, универсальный             |
| firefox     | www.cloudflare.com, cloudflare.com      | Альтернативный браузер             |
| android     | www.google.com, dns.google              | Android-клиенты                    |

**Смена dest и serverNames** (под какой сервис маскируется трафик) без переустановки:

```bash
sudo bash /opt/VPN-XRAY/server/change-dest.sh "dns.google:443" "dns.google,google.com"
```

Или запустите без аргументов — скрипт запросит dest и serverNames. После смены заново сгенерируйте ссылку/QR для клиента.

**dest** должен поддерживать **TLS 1.3** и желательно **HTTP/2**. Часто используют:

- `www.cloudflare.com:443`
- `dns.google:443`
- `www.google.com:443`

Список serverNames должен содержать имена из сертификата выбранного dest (проверьте через `openssl s_client` или документацию сервиса).

---

## Производительность и низкая скорость

Если с iPhone/MacBook скорость очень низкая (например, меньше 1–2 Мбит/с при 100 Мбит/с на VPS), проверьте по шагам.

### 1. Включить BBR на VPS

На сервере выполните один раз:

```bash
cd /opt/VPN-XRAY
sudo bash server/tune-network.sh
```

Скрипт включает BBR и увеличивает TCP-буферы. После этого перезапускать Xray не обязательно.

### 2. Убедиться, что VPS действительно быстрый

На самом сервере:

```bash
curl -s https://raw.githubusercontent.com/sivel/speedtest-cli/master/speedtest.py | python3 -
# или: apt install speedtest-cli && speedtest-cli
```

Если на VPS скорость тоже низкая — ограничение у хостера или тариф.

### 3. Где вы находитесь и где VPS

Большая задержка (Ping 69 мс и выше) и далёкий сервер (другой континент) сами по себе снижают скорость. По возможности выбирайте VPS в том же регионе или стране.

### 4. Мобильный оператор

Проверьте скорость через **другую сеть** (домашний Wi‑Fi, другой оператор). Если по Wi‑Fi скорость нормальная, а по мобильной сети — нет, оператор может ограничивать или приоритизировать трафик.

### 5. Смена порта (443 → 8443, 2053 и т.д.)

Часть провайдеров сильнее нагружает или ограничивает 443. Сменить порт без переустановки:

```bash
sudo bash /opt/VPN-XRAY/server/change-port.sh 8443
```

После смены порта заново сгенерируйте ссылку/QR и обновите профиль на iPhone (новый порт будет в ссылке).

### 6. Клиент на iPhone

В Shadowrocket проверьте: не включён ли режим экономии трафика или ограничение; обновите приложение до последней версии с поддержкой REALITY.

---

## Скорость соединения в туннеле

В конфиге Xray **нет** поля «лимит скорости в Мбит/с». Влиять на поведение туннеля можно так:

### 1. Буфер (policy.bufferSize)

Размер буфера в KB. Чем больше — тем выше может быть пиковая отдача при всплесках; слишком маленький буфер может резать скорость. По умолчанию на сервере часто 512 KB.

Добавить в конфиг блок `policy` с `bufferSize` и перезапустить Xray:

```bash
sudo bash /opt/VPN-XRAY/server/set-policy-buffer.sh 1024
```

(1024 = 1 MB буфера; можно 512, 2048 и т.д.)

### 2. Ограничение скорости (лимит на сервере)

В самом Xray через JSON **не задаётся** лимит в Мбит/с. Чтобы ограничить скорость туннеля, нужно ограничивать трафик на уровне ОС:

- **Через `tc` (traffic control)** — ограничение по порту или по процессу. Пример (ограничить исходящий трафик на порт 2053 до ~10 Мбит/с):

  ```bash
  # Требует знания интерфейса (обычно eth0 или ens3). Пример для 10 Mbit/s:
  sudo tc qdisc add dev eth0 root handle 1: htb default 10
  sudo tc class add dev eth0 parent 1: classid 1:10 htb rate 10mbit
  sudo tc filter add dev eth0 protocol ip parent 1:0 prio 1 u32 match ip sport 2053 0xffff flowid 1:10
  ```

  Интерфейс смотрите в `ip link`. Отмена: `sudo tc qdisc del dev eth0 root`.

- **Через панели** (3X-UI, v2rayA и т.д.) — если поднимаете Xray через панель с gRPC API, в ней часто есть «лимит скорости» на пользователя; там используется API Xray, а не только конфиг.

Итого: «скорость в туннеле» в настройках Xray меняется только буфером (policy); жёсткий лимит в Мбит/с — через `tc` или панель с лимитами.

---

## Рекомендации по стойкости

- **Свой домен и CDN:** для максимальной стойкости рекомендуется использовать **свой домен** с включённым прокси (например, Cloudflare Proxy). В этом случае вы управляете SNI и сертификатом на своей стороне, а трафик идёт через CDN. Решение **работает и без домена** — за счёт подмены отпечатка под публичный dest (Cloudflare, Google и т.д.).
- **Порт 443** предпочтителен — он выглядит как обычный HTTPS.
- Регулярно обновляйте Xray-core до стабильных релизов.

---

## Юридическое предупреждение

**Использование данного ПО должно соответствовать законодательству страны, в которой вы находитесь.** Технология предназначена для защиты приватности и обхода цензуры в рамках законных целей. Не используйте её для незаконной деятельности. Автор не несёт ответственности за неправомерное применение.

---

## Краткая справка по командам

**Сервер (после установки):**

```bash
sudo systemctl status xray
sudo systemctl restart xray
journalctl -u xray -f
# Смена порта (например на 8443):
sudo bash server/change-port.sh 8443
# Буфер туннеля (KB): 512, 1024, 2048
sudo bash server/set-policy-buffer.sh 1024
```

**Клиент (генерация ссылки для iPhone / MacBook):**

```bash
# Ссылка — вставить в Shadowrocket/V2rayU или отправить на iPhone
python3 client/reality-link-gen.py /path/to/reality-client-params.json --link

# QR-код — отсканировать камерой на iPhone
python3 client/reality-link-gen.py /path/to/reality-client-params.json --qr --text
```

**Проверка:**

```bash
./test/verify-tls.sh <IP_СЕРВЕРА> 443 www.cloudflare.com
```
